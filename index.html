<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pok√©mon Spin & Win - Complete App</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');
  body {
    font-family: 'Montserrat', sans-serif;
    background-color: #f72c3d; /* Fallback */
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: 20px;
    position: relative;
    overflow-x: hidden;
  }
  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    background-image: url('https://i.pinimg.com/736x/e5/82/94/e5829441224232ba4dd424fb65a952f1.jpg');
    background-size: cover;
    background-position: center center;
    background-repeat: no-repeat;
  }
  .app-container {
    background: linear-gradient(to bottom, rgba(230, 26, 41, 0.7), rgba(255, 80, 93, 0.7));
    border-radius: 2rem;
    padding: 2rem;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    width: 100%;
    max-width: 400px;
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px); /* For Safari */
  }
  .text-shadow { text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
  .btn {
    padding: 0.75rem 1.5rem;
    border-radius: 9999px;
    font-weight: bold;
    text-transform: uppercase;
    box-shadow: 0 4px 14px 0 rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }
  .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px 0 rgba(0,0,0,0.15); }
  .btn-green { background-color: #28a745; color: white; }
  .btn-yellow { background-color: #ffc107; color: #333; }
  .btn-blue { background-color: #007bff; color: white; }
  .btn-dark { background-color: #343a40; color: white; }
  .btn-orange { background-color: #fd7e14; color: white; }
  .btn:disabled { background-color: #6c757d; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.7; }

  .input-field {
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.4);
    color: white;
    padding: 1rem;
    border-radius: 0.75rem;
  }
  .input-field::placeholder { color: rgba(255, 255, 255, 0.7); }

  .wheel-spinner {
    position: relative; width: 100%; height: 100%; border-radius: 50%;
    border: 8px solid #fff; box-shadow: 0 0 20px rgba(0,0,0,0.5);
    transition: transform 5s cubic-bezier(0.25, 1, 0.5, 1);
  }
  .wheel-segment {
    position: absolute; width: 50%; height: 50%; transform-origin: 100% 100%; overflow: hidden;
  }
  .wheel-segment .text {
    position: absolute; left: -100%; width: 200%; height: 200%; text-align: center;
    padding-top: 20px; color: white; font-weight: bold; font-size: 12px;
    text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
  }
  .wheel-pointer {
    position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
    width: 0; height: 0; border-left: 20px solid transparent;
    border-right: 20px solid transparent; border-bottom: 30px solid #ffc107; z-index: 10;
  }
  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  .loader-spinner {
    border: 8px solid rgba(255, 255, 255, 0.3); border-top: 8px solid white;
    border-radius: 50%; width: 80px; height: 80px; animation: spin 1s linear infinite;
  }
  .btn .btn-spinner {
    border: 3px solid rgba(255, 255, 255, 0.3); border-top: 3px solid white;
    border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite;
  }
  #toast-container {
    position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px;
  }
  .toast {
    padding: 1rem; border-radius: 0.5rem; color: white; font-weight: bold;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2); transform: translateX(120%);
    opacity: 0; animation: slideIn 0.5s forwards;
  }
  .toast.success { background-color: #28a745; }
  .toast.error { background-color: #dc3545; }
  @keyframes slideIn { to { transform: translateX(0); opacity: 1; } }

  .legal-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    padding: 20px;
  }
  .legal-content {
    background: #fff;
    color: #333;
    padding: 2rem;
    border-radius: 1rem;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
  }
  .legal-content h2 {
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 1rem;
  }
  .legal-content p, .legal-content li {
    margin-bottom: 0.75rem;
    font-size: 0.9rem;
    line-height: 1.5;
  }
</style>
</head>
<body>

<div id="toast-container"></div>

<div class="app-container">
  <!-- Loader Screen -->
  <div id="loader-screen" class="flex flex-col items-center justify-center space-y-4">
    <div class="loader-spinner"></div>
    <p class="text-xl font-bold text-white text-shadow">laden...</p>
  </div>

  <!-- Login/Register Screens (Combined) -->
  <div id="auth-screen" class="space-y-6 hidden">
    <div class="text-center">
      <img src="https://brown-turkey-493487.hostingersite.com/wp-content/uploads/2025/05/logo-2.png" alt="Pok√©mon Veiling Logo" class="w-full max-w-[195px] mx-auto mb-4">
      <h2 id="auth-title" class="text-2xl font-bold text-white text-shadow mb-2">Welkom Terug!</h2>
      <button id="authToggleButton" class="text-yellow-300 font-bold bg-transparent border-none mb-4">Nog geen account? Registreer hier</button>
      <p id="auth-context-message" class="text-yellow-200"></p>
    </div>
    <div class="space-y-4">
      <input type="tel" id="authPhone" placeholder="Jouw telefoonnummer" class="w-full input-field">
      <div id="register-legal-section" class="hidden text-left text-xs text-white mt-4">
          <input type="checkbox" id="legal-agree-checkbox" class="mr-2">
          <label for="legal-agree-checkbox">Ik ben 18 jaar of ouder en ga akkoord met de <a href="#" id="show-terms-link" class="underline">Algemene Voorwaarden</a> en het <a href="#" id="show-privacy-link" class="underline">Privacybeleid</a>.</label>
      </div>
      <span id="auth-error-message" class="text-yellow-300 text-sm hidden"></span>
      <button id="authButton" class="w-full btn btn-green">Login</button>
    </div>
  </div>

  <!-- Card Selection Screen -->
  <div id="cards-screen" class="space-y-4 hidden">
    <img src="https://brown-turkey-493487.hostingersite.com/wp-content/uploads/2025/05/logo-2.png" alt="Pok√©mon Veiling Logo" class="w-full max-w-[195px] mx-auto">
    <button id="goToUploadButton" class="w-full btn btn-orange">Login om te Verkopen</button>
    <div class="flex justify-between items-center text-white">
        <div>
            <h2 class="text-2xl font-bold text-shadow">Actieve Veilingen</h2>
            <p class="text-sm opacity-80">Doe mee aan een veiling.</p>
        </div>
        <button id="logoutButton" class="btn btn-orange btn-sm !py-2 !px-3">Uitloggen</button>
    </div>
    <div id="active-auctions-list" class="space-y-2 max-h-[50vh] overflow-y-auto"></div>
    <button id="goToDashboardButton" class="w-full btn btn-dark">Dashboard</button>
    <footer class="text-center text-xs text-white/70 mt-4">
      <a href="#" id="footer-terms-link" class="underline">Algemene Voorwaarden</a> |
      <a href="#" id="footer-privacy-link" class="underline">Privacybeleid</a>
    </footer>
  </div>

  <!-- Upload Screen -->
  <div id="upload-screen" class="space-y-6 hidden">
    <img src="https://brown-turkey-493487.hostingersite.com/wp-content/uploads/2025/05/logo-2.png" alt="Pok√©mon Veiling Logo" class="w-full max-w-[195px] mx-auto">
    <div class="text-center">
      <h2 class="text-2xl font-bold text-white text-shadow">Upload jouw Pok√©mon-kaart</h2>
    </div>
    <div class="space-y-4">
      <input type="file" id="uploadFileInput" accept="image/*" capture="environment" class="hidden">
      <button id="uploadFileTriggerButton" class="w-full btn btn-dark">Maak een Foto van je Kaart</button>
      <img id="imagePreview" src="" alt="Image Preview" class="w-48 h-64 object-cover mx-auto rounded-lg hidden shadow-lg"/>
      <input type="text" id="uploadCardName" placeholder="Naam kaart" class="w-full input-field">
      <input type="number" id="uploadCardPrice" placeholder="Vraagprijs (‚Ç¨)" class="w-full input-field">
      <input type="number" id="uploadCardSpots" placeholder="Aantal spots/deelnemers" class="w-full input-field">
    </div>
    <button id="saveUploadButton" class="w-full btn btn-green">Opslaan & Promoten</button>
    <button id="backToCardsButton" class="w-full btn btn-dark mt-2">Terug naar Overzicht</button>
  </div>

  <!-- Promotion Screen -->
  <div id="promotion-screen" class="space-y-6 hidden">
      <img src="https://brown-turkey-493487.hostingersite.com/wp-content/uploads/2025/05/logo-2.png" alt="Pok√©mon Veiling Logo" class="w-full max-w-[195px] mx-auto">
      <div class="text-center">
        <h2 class="text-2xl font-bold text-white text-shadow">Promoot je Kaart!</h2>
        <p class="text-white/80 text-sm">Deel de link om je veiling te vullen.</p>
      </div>
      <div id="promotionCardDetails" class="bg-black/20 p-4 rounded-lg text-white text-center"></div>
      <div class="text-center">
          <p id="spotProgress" class="text-2xl font-bold text-white">0 / 4 spots gevuld</p>
          <div class="w-full bg-gray-200 rounded-full h-4 mt-2 bg-black/30">
              <div id="spotProgressBar" class="bg-green-500 h-4 rounded-full" style="width: 0%"></div>
          </div>
      </div>
      <div class="space-y-3">
          <h3 class="text-center text-white font-bold">Deel je veiling:</h3>
          <button id="shareWhatsapp" class="w-full btn btn-green"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.001 2.267.655 4.398 1.803 6.12l-1.34 4.887 4.939-1.307z"/></svg> Deel op WhatsApp</button>
          <button id="copyLink" class="w-full btn btn-blue">Kopieer Link</button>
      </div>
      <button id="promotionDoneButton" class="w-full btn btn-dark mt-4">Klaar</button>
  </div>

  <!-- Auction Join Screen -->
  <div id="auction-join-screen" class="space-y-4 hidden">
      <img src="https://brown-turkey-493487.hostingersite.com/wp-content/uploads/2025/05/logo-2.png" alt="Pok√©mon Veiling Logo" class="w-full max-w-[195px] mx-auto">
      <div class="text-center">
        <h2 class="text-2xl font-bold text-white text-shadow">Doe Mee met de Veiling!</h2>
        <p class="text-white/80 text-sm">Koop een spot en maak kans op deze kaart.</p>
      </div>
      <div id="auctionJoinCardDetails" class="bg-black/20 p-4 rounded-lg text-white text-center"></div>
      <button id="buySpotButton" class="w-full btn btn-yellow text-lg py-4">Koop Spot</button>
      <div class="text-center">
          <p id="auctionJoinSpotProgress" class="text-2xl font-bold text-white">0 / 4 spots gevuld</p>
          <div class="w-full bg-black/30 rounded-full h-4 mt-2">
              <div id="auctionJoinSpotProgressBar" class="bg-green-500 h-4 rounded-full" style="width: 0%"></div>
          </div>
      </div>
      <div id="auctionParticipants" class="bg-black/20 p-4 rounded-lg text-white"></div>
      <button id="shareWhatsappAuctionJoin" class="w-full btn btn-green"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.001 2.267.655 4.398 1.803 6.12l-1.34 4.887 4.939-1.307z"/></svg> Deel via WhatsApp</button>
      <button id="backToAuctionsButton" class="w-full btn btn-dark mt-2">Terug naar Overzicht</button>
  </div>

  <!-- Checkout Screen -->
  <div id="checkout-screen" class="space-y-6 hidden text-center text-white">
      <img src="https://brown-turkey-493487.hostingersite.com/wp-content/uploads/2025/05/logo-2.png" alt="Pok√©mon Veiling Logo" class="w-full max-w-[195px] mx-auto">
      <h2 class="text-2xl font-bold text-white text-shadow">Afrekenen</h2>
      <img src="https://www.toolsafety.nl/wp-content/uploads/2019/07/IDeal-logo-ToolSafety.png" alt="iDEAL Logo" class="w-32 mx-auto">
      <p class="text-sm opacity-80 -mt-2">via Rabobank Smart Pay</p>
      <div id="checkout-summary" class="bg-black/20 p-4 rounded-lg"></div>

      <div class="text-left text-xs text-white mt-4">
          <input type="checkbox" id="withdrawal-agree-checkbox" class="mr-2">
          <label for="withdrawal-agree-checkbox">Ik ga akkoord dat de dienst direct wordt geleverd en zie daarmee af van mijn herroepingsrecht.</label>
      </div>

      <button id="checkout-pay-button" class="w-full btn btn-green">Betaal nu</button>
      <button id="checkout-cancel-button" class="w-full btn btn-dark mt-2">Annuleer</button>
  </div>

  <!-- Wheel Screen -->
  <div id="wheel-screen" class="space-y-4 hidden">
      <img src="https://brown-turkey-493487.hostingersite.com/wp-content/uploads/2025/05/logo-2.png" alt="Pok√©mon Veiling Logo" class="w-full max-w-[195px] mx-auto">
      <div class="text-center">
          <h2 class="text-2xl font-bold text-white text-shadow">De Veiling is Vol!</h2>
          <p id="wheelCardName" class="text-white/80 text-sm">Draai aan het rad om de winnaar te bepalen.</p>
      </div>
      <div class="relative w-64 h-64 mx-auto my-4">
          <div class="wheel-pointer"></div>
          <div id="wheelSpinner" class="wheel-spinner"></div>
      </div>
      <button id="spinButton" class="w-full btn btn-yellow">Draai het Rad!</button>
  </div>

  <!-- Winner Screen -->
  <div id="winner-screen" class="space-y-6 hidden text-center text-white">
      <img src="https://brown-turkey-493487.hostingersite.com/wp-content/uploads/2025/05/logo-2.png" alt="Pok√©mon Veiling Logo" class="w-full max-w-[195px] mx-auto">
      <h2 class="text-2xl font-bold text-shadow">Gefeliciteerd!</h2>
      <img id="winnerCardImage" src="" alt="Gewonnen kaart" class="w-48 h-64 object-cover mx-auto rounded-lg shadow-lg"/>
      <p class="text-3xl font-bold text-yellow-300" id="winnerPhoneNumber"></p>
      <p>Is de winnaar van de <strong id="winnerCardName"></strong>!</p>
      <div id="winner-contact-area" class="mt-6"></div>
      <button id="winnerDoneButton" class="w-full btn btn-dark mt-4">Bekijk Andere Veilingen</button>
  </div>

  <!-- Dashboard Screen -->
  <div id="dashboard-screen" class="space-y-6 hidden">
    <img src="https://brown-turkey-493487.hostingersite.com/wp-content/uploads/2025/05/logo-2.png" alt="Pok√©mon Veiling Logo" class="w-full max-w-[195px] mx-auto">
    <div class="flex justify-between items-center text-white">
        <h2 class="text-2xl font-bold text-shadow">Dashboard</h2>
        <button id="dashboardBackButton" class="btn btn-dark btn-sm !py-2 !px-3">Terug</button>
    </div>
    <div class="bg-black/20 p-4 rounded-lg">
      <h3 class="text-white text-lg font-bold mb-2">Jouw Ge√ºploade Kaarten</h3>
      <div id="dashboard-my-auctions" class="space-y-2 max-h-40 overflow-y-auto"></div>
    </div>
    <div class="bg-black/20 p-4 rounded-lg">
      <h3 class="text-white text-lg font-bold mb-2">Deelgenomen Veilingen</h3>
      <div id="dashboard-participated-auctions" class="space-y-2 max-h-40 overflow-y-auto"></div>
    </div>
    <button id="logoutButtonDashboard" class="w-full btn btn-orange mt-2">Uitloggen</button>
  </div>
</div>

<!-- Image Modal -->
<div id="image-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 hidden">
  <span id="image-modal-close" class="absolute top-4 right-4 text-white text-4xl font-bold cursor-pointer">&times;</span>
  <img id="image-modal-content" src="" alt="Vergrote kaart" class="max-w-full max-h-full object-contain">
</div>

<!-- Legal Modals -->
<div id="terms-modal" class="legal-modal hidden">
    <div class="legal-content">
        <h2 class="text-gray-800">Algemene Voorwaarden</h2>
        <p><strong>Artikel 1: Definities</strong><br>Platform: Deze webapplicatie. Gebruiker: Iedere natuurlijke persoon die gebruikmaakt van het Platform. Veiling: Het proces waarbij Gebruikers Spots kunnen kopen voor een kans om een product te winnen. Spot: Een deelnamebewijs voor een Veiling.</p>
        <p><strong>Artikel 2: Toepasselijkheid</strong><br>Deze voorwaarden zijn van toepassing op al het gebruik van het Platform.</p>
        <p><strong>Artikel 3: Registratie en Gebruik</strong><br>Gebruiker dient 18 jaar of ouder te zijn. Het aanbieden van illegale producten is verboden.</p>
        <p><strong>Artikel 4: Aanbod</strong><br>De Veiling is een kansspel. De winnaar wordt willekeurig bepaald nadat alle Spots zijn verkocht.</p>
        <p><strong>Artikel 5: Betaling</strong><br>Betalingen voor Spots worden verwerkt door een externe betaalprovider en zijn definitief.</p>
        <p><strong>Artikel 6: Herroepingsrecht</strong><br>Door een Spot te kopen, stemt de Gebruiker ermee in dat de dienst direct wordt geleverd. Hiermee ziet de Gebruiker af van het wettelijke herroepingsrecht van 14 dagen.</p>
        <p><strong>Artikel 7: Aansprakelijkheid</strong><br>Het Platform is een facilitator en is niet aansprakelijk voor de kwaliteit van de aangeboden producten of voor geschillen tussen Gebruikers.</p>
        <p><strong>Artikel 8: Contact en Klachten</strong><br>Voor vragen of klachten kunt u contact opnemen via rowanveenendaal@gmail.com.</p>
        <button id="close-terms-modal" class="w-full btn btn-dark mt-4">Sluiten</button>
    </div>
</div>

<div id="privacy-modal" class="legal-modal hidden">
    <div class="legal-content">
        <h2 class="text-gray-800">Privacybeleid</h2>
        <p><strong>Verwerkingsverantwoordelijke:</strong> Yoursell, gevestigd te Commandeursweg 500 B6 te Bennekom.</p>
        <p><strong>Welke gegevens verwerken wij?</strong><br>Wij verwerken uw telefoonnummer voor accountregistratie en om contact tussen koper en verkoper mogelijk te maken.</p>
        <p><strong>Doel van de verwerking</strong><br>Uw gegevens worden gebruikt voor het functioneren van het Platform, zoals identificatie bij deelname en communicatie na een gewonnen veiling.</p>
        <p><strong>Bewaartermijn</strong><br>Uw gegevens worden bewaard zolang uw account actief is.</p>
        <p><strong>Uw rechten (AVG)</strong><br>U heeft het recht op inzage, rectificatie, en verwijdering van uw persoonsgegevens.</p>
        <button id="close-privacy-modal" class="w-full btn btn-dark mt-4">Sluiten</button>
    </div>
</div>

<script type="module">
  // Importeer Firebase services
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot, updateDoc, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  // --- De Firebase configuratie is nu compleet ---
  const firebaseConfig = {
    apiKey: "AIzaSyCg4BGRMGz9k4rvQirEqGvzFJEAgrcLaj0",
    authDomain: "pokemon-62a02.firebaseapp.com",
    projectId: "pokemon-62a02",
    storageBucket: "pokemon-62a02.appspot.com",
    messagingSenderId: "766726699342",
    appId: "1:766726699342:web:973cc52751232adb0f861f"
  };

  // Initialiseer Firebase
  let app, db, storage;
  try {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    storage = getStorage(app);
  } catch (error) {
    console.error("Firebase initialization failed:", error);
    alert("Kon geen verbinding maken met de server. Controleer je Firebase configuratie.");
  }


  // --- Gebruik localStorage voor de 'huidige gebruiker' state ---
  const LocalState = {
    getCurrentUserPhone: () => localStorage.getItem('currentUserPhone'),
    setCurrentUserPhone: (phone) => localStorage.setItem('currentUserPhone', phone),
    logout: () => localStorage.removeItem('currentUserPhone'),
    getPendingAuctionId: () => sessionStorage.getItem('pendingAuctionId'),
    setPendingAuctionId: (id) => sessionStorage.setItem('pendingAuctionId', id),
    clearPendingAuctionId: () => sessionStorage.removeItem('pendingAuctionId'),
  };

  // --- DOM Elements ---
  const screens = {
    loader: document.getElementById('loader-screen'),
    auth: document.getElementById('auth-screen'),
    cards: document.getElementById('cards-screen'),
    upload: document.getElementById('upload-screen'),
    promotion: document.getElementById('promotion-screen'),
    auctionJoin: document.getElementById('auction-join-screen'),
    checkout: document.getElementById('checkout-screen'),
    wheel: document.getElementById('wheel-screen'),
    winner: document.getElementById('winner-screen'),
    dashboard: document.getElementById('dashboard-screen'),
  };

  const imageModal = document.getElementById('image-modal');
  const imageModalContent = document.getElementById('image-modal-content');
  const imageModalClose = document.getElementById('image-modal-close');
  const termsModal = document.getElementById('terms-modal');
  const privacyModal = document.getElementById('privacy-modal');

  let state = {
      isLogin: true,
      currentAuctionId: null,
      uploadedFile: null,
      isSpinning: false,
      allAuctions: [],
  };

  // --- UI & Helper Functions ---
  const showToast = (message, type = 'success') => {
    const toastContainer = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    toastContainer.appendChild(toast);
    setTimeout(() => {
        toast.remove();
    }, 3000);
  };

  const setLoadingState = (button, isLoading) => {
    const originalText = button.dataset.originalText || button.innerHTML;
    if (isLoading) {
        if (!button.dataset.originalText) {
            button.dataset.originalText = button.innerHTML;
        }
        button.disabled = true;
        button.innerHTML = `<div class="btn-spinner"></div>`;
    } else {
        button.disabled = false;
        button.innerHTML = originalText;
        delete button.dataset.originalText;
    }
  };

  function showImageModal(src) {
    imageModalContent.src = src;
    imageModal.classList.remove('hidden');
  }

  function hideImageModal() {
    imageModal.classList.add('hidden');
  }

  // --- Screen Navigation ---
  function showScreen(screenName, auctionId = null) {
    state.currentAuctionId = auctionId;
    Object.values(screens).forEach(screen => screen.classList.add('hidden'));
    if (screens[screenName]) {
      screens[screenName].classList.remove('hidden');
    }
    // Refresh data based on screen
    if (screenName === 'dashboard') showDashboard();
    if (screenName === 'auctionJoin') showAuctionJoinScreen(auctionId);
    if (screenName === 'checkout') setupCheckoutScreen(auctionId);
  }

  // --- Auth Functions ---
  function setupAuthScreen() {
    const title = document.getElementById('auth-title');
    const button = document.getElementById('authButton');
    const toggleButton = document.getElementById('authToggleButton');
    const phoneInput = document.getElementById('authPhone');
    const registerLegalSection = document.getElementById('register-legal-section');
    phoneInput.value = '';

    if (state.isLogin) {
        title.textContent = "Welkom Terug!";
        button.textContent = "Login";
        toggleButton.innerHTML = "Nog geen account? <strong>Registreer hier</strong>";
        registerLegalSection.classList.add('hidden');
        button.disabled = false;
    } else {
        title.textContent = "Maak een Account";
        button.textContent = "Registreer";
        toggleButton.innerHTML = "Al een account? <strong>Login hier</strong>";
        registerLegalSection.classList.remove('hidden');
        button.disabled = true; // Initially disable register button
    }
  }

  async function handleAuth() {
      const phone = document.getElementById('authPhone').value;
      const errorEl = document.getElementById('auth-error-message');
      errorEl.classList.add('hidden');

      if (!/^\d{10}$/.test(phone)) { // Simple validation for 10 digits
          errorEl.textContent = 'Vul een geldig 10-cijferig telefoonnummer in.';
          errorEl.classList.remove('hidden');
          return;
      }

      try {
        const userDocRef = doc(db, "users", phone);
        const userDoc = await getDoc(userDocRef);

        if (state.isLogin) {
            if (userDoc.exists()) {
                loginSuccess(phone);
            } else {
                errorEl.textContent = 'Telefoonnummer niet gevonden. Probeer te registreren.';
                errorEl.classList.remove('hidden');
            }
        } else { // Register
            if (userDoc.exists()) {
                errorEl.textContent = 'Dit telefoonnummer is al in gebruik.';
                errorEl.classList.remove('hidden');
            } else {
                await setDoc(userDocRef, { phone: phone, timestamp: serverTimestamp() });
                showToast('Registratie succesvol!');
                loginSuccess(phone);
            }
        }
      } catch (error) {
        console.error("Firebase Auth Error:", error);
        errorEl.textContent = 'Kon niet verbinden met de database. Controleer de Firebase-regels in je project.';
        errorEl.classList.remove('hidden');
      }
  }

  function loginSuccess(phone) {
    LocalState.setCurrentUserPhone(phone);

    const urlParams = new URLSearchParams(window.location.search);
    const paymentSuccess = urlParams.get('payment_success');
    const pendingAuctionId = urlParams.get('auctionId') || LocalState.getPendingAuctionId();

    if (paymentSuccess && pendingAuctionId) {
        handleSuccessfulPayment(pendingAuctionId);
        history.replaceState(null, '', window.location.pathname);
    } else if (pendingAuctionId) {
        LocalState.clearPendingAuctionId();
        const auction = state.allAuctions.find(a => a.id === pendingAuctionId);
        if (auction?.status === 'ready_to_spin') {
            showWheelScreen(pendingAuctionId);
        } else {
            showScreen('auctionJoin', pendingAuctionId);
        }
    } else {
        showScreen('cards');
    }
    updateHeaderButtons();
  }

  function handleLogout() {
      LocalState.logout();
      showScreen('cards');
      updateHeaderButtons();
      showToast("Je bent uitgelogd.", "success");
  }

  function updateHeaderButtons() {
      const isLoggedIn = !!LocalState.getCurrentUserPhone();
      const logoutButton = document.getElementById('logoutButton');
      const goToUploadButton = document.getElementById('goToUploadButton');
      const goToDashboardButton = document.getElementById('goToDashboardButton');

      logoutButton.style.display = isLoggedIn ? 'inline-flex' : 'none';
      goToDashboardButton.style.display = isLoggedIn ? 'block' : 'none';

      if (isLoggedIn) {
          goToUploadButton.textContent = "Verkoop Kaart";
          goToUploadButton.onclick = () => showScreen('upload');
      } else {
          goToUploadButton.textContent = "Login om te Verkopen";
          goToUploadButton.onclick = () => showScreen('auth');
      }
  }

  // --- Main App Logic ---
  function renderActiveAuctions() {
      const auctions = state.allAuctions.filter(a => a.status !== 'completed');
      const container = document.getElementById('active-auctions-list');
      container.innerHTML = '';
      if(auctions.length === 0) {
          container.innerHTML = '<p class="text-white/70 text-center p-4">Er zijn momenteel geen actieve veilingen.</p>';
          return;
      }
      auctions.forEach(auction => {
          const pricePerSpot = (auction.price / auction.spots).toFixed(2);
          const spotsFilled = auction.participants.length;
          const isFull = spotsFilled >= auction.spots;

          const element = document.createElement('div');
          element.className = 'bg-black/20 p-3 rounded-lg flex items-center justify-between cursor-pointer hover:bg-black/30 transition-all';
          element.dataset.auctionId = auction.id;
          element.dataset.isFull = isFull;
          element.innerHTML = `
            <div class="flex items-center flex-grow">
                <img src="${auction.img}" alt="${auction.name}" class="w-12 h-16 object-cover rounded mr-3">
                <div class="text-white text-sm">
                    <p class="font-bold">${auction.name}</p>
                    <p>${spotsFilled}/${auction.spots} bezet ‚Ä¢ ‚Ç¨${pricePerSpot}/spot</p>
                </div>
            </div>
            ${isFull
              ? `<span class="bg-orange-500 text-white text-xs font-bold px-2 py-1 rounded-full">VOL</span>`
              : `<button class="btn btn-green btn-sm !py-1 !px-3 pointer-events-none">Doe Mee</button>`
            }
          `;
          container.appendChild(element);
      });
  }

  async function handleFileUpload(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
            state.uploadedFile = await resizeImage(e.target.result);
            const imagePreview = document.getElementById('imagePreview');
            imagePreview.src = state.uploadedFile;
            imagePreview.classList.remove('hidden');
            imagePreview.onclick = () => showImageModal(state.uploadedFile);
        } catch (error) {
            showToast("Afbeelding kon niet worden verwerkt.", 'error');
            state.uploadedFile = null;
        }
      };
      reader.readAsDataURL(file);
    }
  }

  function resizeImage(base64Str, maxWidth = 400, maxHeight = 600) {
      return new Promise((resolve) => {
          let img = new Image();
          img.src = base64Str;
          img.onload = () => {
              let canvas = document.createElement('canvas'), ctx = canvas.getContext('2d');
              let { width, height } = img;
              if (width > height) {
                  if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
              } else {
                  if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; }
              }
              canvas.width = width; canvas.height = height;
              ctx.drawImage(img, 0, 0, width, height);
              resolve(canvas.toDataURL('image/jpeg', 0.7));
          };
      });
  }

  async function saveUploadedCard(button) {
    const cardName = document.getElementById('uploadCardName').value;
    const cardPrice = parseFloat(document.getElementById('uploadCardPrice').value);
    const cardSpots = parseInt(document.getElementById('uploadCardSpots').value);

    if (!cardName || !cardPrice || !cardSpots || !state.uploadedFile) {
      showToast("Vul alle velden in en kies een afbeelding.", "error");
      return;
    }
    if (cardPrice <= 0 || cardSpots <= 1) {
      showToast("Prijs en aantal spots moeten positief zijn (spots > 1).", "error");
      return;
    }

    setLoadingState(button, true);

    try {
        // Upload image to Firebase Storage
        const id = Date.now().toString();
        const storageRef = ref(storage, `auctions/${id}.jpg`);
        const snapshot = await uploadString(storageRef, state.uploadedFile, 'data_url');
        const imageUrl = await getDownloadURL(snapshot.ref);

        // Save auction to Firestore
        const auctionDocRef = doc(db, "auctions", id);
        const card = {
            id: id, name: cardName, price: cardPrice, spots: cardSpots,
            img: imageUrl, ownerPhone: LocalState.getCurrentUserPhone(), participants: [],
            timestamp: serverTimestamp(), status: 'active',
        };
        await setDoc(auctionDocRef, card);

        document.getElementById('uploadCardName').value = '';
        document.getElementById('uploadCardPrice').value = '';
        document.getElementById('uploadCardSpots').value = '';
        state.uploadedFile = null;
        document.getElementById('imagePreview').classList.add('hidden');

        showPromotionScreen(card);
    } catch (error) {
        console.error("Error saving auction:", error);
        showToast("Fout bij opslaan van veiling.", "error");
    } finally {
        setLoadingState(button, false);
    }
  }

  function showPromotionScreen(card) {
    showScreen('promotion', card.id);
    const detailsContainer = document.getElementById('promotionCardDetails');
    const pricePerSpot = (card.price / card.spots).toFixed(2);
    detailsContainer.innerHTML = `
        <img src="${card.img}" alt="${card.name}" class="w-48 h-64 object-cover mx-auto rounded-lg mb-2 shadow-lg cursor-pointer">
        <h3 class="text-xl font-bold">${card.name}</h3>
        <p class="text-lg text-yellow-300">‚Ç¨${pricePerSpot} per spot</p>
    `;
    detailsContainer.querySelector('img').onclick = () => showImageModal(card.img);
    updateSpotProgress(document.getElementById('spotProgress'), document.getElementById('spotProgressBar'), card);

    document.getElementById('shareWhatsapp').onclick = () => shareOnWhatsApp(card.id);
    document.getElementById('copyLink').onclick = (e) => copyPromoLink(card.id, e.currentTarget);
  }

  function showAuctionJoinScreen(auctionId) {
      state.currentAuctionId = auctionId;
      const auction = state.allAuctions.find(a => a.id === auctionId);
      if (!auction) {
          showToast("Veiling niet gevonden!", "error");
          showScreen('cards');
          return;
      }

      const detailsContainer = document.getElementById('auctionJoinCardDetails');
      detailsContainer.innerHTML = `
          <img src="${auction.img}" alt="${auction.name}" class="w-48 h-64 object-cover mx-auto rounded-lg mb-2 shadow-lg cursor-pointer">
          <h3 class="text-xl font-bold">${auction.name}</h3>
          <p class="text-lg text-yellow-300">‚Ç¨${(auction.price / auction.spots).toFixed(2)} per spot</p>
      `;
      detailsContainer.querySelector('img').onclick = () => showImageModal(auction.img);
      updateAuctionJoinUI(auction);
  }

  function updateAuctionJoinUI(auction) {
      updateSpotProgress(
          document.getElementById('auctionJoinSpotProgress'),
          document.getElementById('auctionJoinSpotProgressBar'),
          auction
      );
      const participantsContainer = document.getElementById('auctionParticipants');
      participantsContainer.innerHTML = '<h3 class="font-bold mb-2">Deelnemers:</h3>';
      if (auction.participants && auction.participants.length > 0) {
          const list = document.createElement('ul');
          list.className = 'list-disc list-inside';
          auction.participants.forEach(p => {
              const item = document.createElement('li');
              item.textContent = `...${p.slice(-4)}`;
              list.appendChild(item);
          });
          participantsContainer.appendChild(list);
      } else {
          participantsContainer.innerHTML += '<p class="text-sm text-white/70">Nog geen deelnemers.</p>';
      }

      const buyButton = document.getElementById('buySpotButton');
      const currentUserPhone = LocalState.getCurrentUserPhone();

      if (auction.participants.includes(currentUserPhone)) {
          buyButton.disabled = true;
          buyButton.textContent = 'Je doet al mee!';
      } else if (auction.participants.length >= auction.spots) {
          buyButton.disabled = true;
          buyButton.textContent = 'Veiling is vol';
      } else {
          buyButton.disabled = false;
          buyButton.textContent = `Koop Spot (‚Ç¨${(auction.price / auction.spots).toFixed(2)})`;
      }
  }

  function updateSpotProgress(textEl, barEl, auction) {
      const filled = auction.participants ? auction.participants.length : 0;
      textEl.textContent = `${filled} / ${auction.spots} spots gevuld`;
      barEl.style.width = `${(filled / auction.spots) * 100}%`;
  }

  // --- Payment Flow (Rabobank Smart Pay) ---
  function handleBuySpot() {
    if (!LocalState.getCurrentUserPhone()) {
        showToast("Je moet ingelogd zijn om een spot te kopen.", 'error');
        LocalState.setPendingAuctionId(state.currentAuctionId);
        document.getElementById('auth-context-message').textContent = "Login om je aankoop af te ronden.";
        showScreen('auth');
        return;
    }
    showScreen('checkout', state.currentAuctionId);
  }

  function setupCheckoutScreen(auctionId) {
      state.currentAuctionId = auctionId;
      const auction = state.allAuctions.find(a => a.id === auctionId);
      const currentUserPhone = LocalState.getCurrentUserPhone();
      const checkoutSummary = document.getElementById('checkout-summary');
      const payButton = document.getElementById('checkout-pay-button');
      const withdrawalCheckbox = document.getElementById('withdrawal-agree-checkbox');
      withdrawalCheckbox.checked = false; // Reset checkbox
      payButton.disabled = true; // Disable pay button initially
      const pricePerSpot = (auction.price / auction.spots).toFixed(2);

      checkoutSummary.innerHTML = `
        <div class="text-left space-y-2">
            <p><strong>Product:</strong> Spot voor ${auction.name}</p>
            <p><strong>Veilinghouder:</strong> ...${auction.ownerPhone.slice(-4)}</p>
            <p><strong>Jouw Telefoonnummer:</strong> ...${currentUserPhone.slice(-4)}</p>
            <hr class="border-white/20 my-3">
            <div class="flex justify-between items-center text-xl">
                <span>Totaal te betalen:</span>
                <strong class="text-2xl text-yellow-300">‚Ç¨${pricePerSpot}</strong>
            </div>
        </div>
      `;
  }

  async function processPayment(button) {
      setLoadingState(button, true);
      const auction = state.allAuctions.find(a => a.id === state.currentAuctionId);
      if (!auction) {
          showToast('Veiling niet gevonden.', 'error');
          setLoadingState(button, false);
          return;
      }

      showToast("Betaling wordt verwerkt...", "success");

      // Simuleer een netwerkvertraging en een succesvolle betaling
      setTimeout(() => {
          setLoadingState(button, false);
          handleSuccessfulPayment(auction.id);
      }, 2000);
  }

  async function handleSuccessfulPayment(auctionId) {
      const currentUserPhone = LocalState.getCurrentUserPhone();
      const auctionDocRef = doc(db, "auctions", auctionId);

      try {
          // Update participants in Firestore
          await updateDoc(auctionDocRef, {
              participants: arrayUnion(currentUserPhone)
          });

          // Fetch the latest auction data to check if it's full
          const updatedAuctionDoc = await getDoc(auctionDocRef);
          const auction = updatedAuctionDoc.data();

          if (auction.participants.length === parseInt(auction.spots, 10)) {
              await updateDoc(auctionDocRef, { status: 'ready_to_spin' });
              showToast("Laatste spot gevuld! De veiling gaat beginnen.");
              showWheelScreen(auctionId);
          } else {
              showToast("Betaling geslaagd! Je doet mee.", "success");
              showScreen('auctionJoin', auctionId);
          }
      } catch (error) {
          console.error("Payment handling error:", error);
          showToast("Fout bij verwerken van betaling.", "error");
      }
  }


  // --- Wheel & Winner ---
  async function showWheelScreen(auctionId) {
      const auction = state.allAuctions.find(a => a.id === auctionId);
      if (!auction) { showToast('Veiling niet gevonden', 'error'); return showScreen('cards'); }

      document.getElementById('wheelCardName').textContent = `Veiling voor: ${auction.name}`;
      const wheelSpinner = document.getElementById('wheelSpinner');
      wheelSpinner.innerHTML = '';
      const participants = auction.participants;
      const segmentAngle = 360 / participants.length;
      const colors = ['#e61a29', '#ff505d', '#343a40', '#007bff', '#28a745', '#fd7e14'];

      participants.forEach((p, index) => {
          const segment = document.createElement('div');
          segment.className = 'wheel-segment';
          segment.style.transform = `rotate(${index * segmentAngle}deg)`;
          segment.style.backgroundColor = colors[index % colors.length];

          const text = document.createElement('div');
          text.className = 'text';
          text.textContent = `...${p.slice(-4)}`;
          text.style.transform = `rotate(${segmentAngle / 2}deg)`;

          segment.appendChild(text);
          wheelSpinner.appendChild(segment);
      });

      document.getElementById('spinButton').onclick = () => spinWheel(auction);
      showScreen('wheel', auctionId);
  }

  async function spinWheel(auction) {
      if (state.isSpinning) return;
      state.isSpinning = true;
      document.getElementById('spinButton').disabled = true;

      const winnerIndex = Math.floor(Math.random() * auction.participants.length);
      const winnerPhone = auction.participants[winnerIndex];
      const segmentAngle = 360 / auction.participants.length;
      const randomOffset = (Math.random() * 0.8 + 0.1) * segmentAngle;
      const targetRotation = (360 * 5) - (winnerIndex * segmentAngle) - randomOffset;

      document.getElementById('wheelSpinner').style.transform = `rotate(${targetRotation}deg)`;

      // Update winner in Firestore after animation starts
      const auctionDocRef = doc(db, "auctions", auction.id);
      await updateDoc(auctionDocRef, { status: 'completed', winner: winnerPhone });

      setTimeout(() => {
          showWinnerScreen(auction, winnerPhone);
          state.isSpinning = false;
          document.getElementById('spinButton').disabled = false;
      }, 5500);
  }

  function showWinnerScreen(auction, winnerPhone) {
      const winnerCardImage = document.getElementById('winnerCardImage');
      winnerCardImage.src = auction.img;
      winnerCardImage.classList.add('cursor-pointer');
      winnerCardImage.onclick = () => showImageModal(auction.img);

      document.getElementById('winnerCardName').textContent = auction.name;
      document.getElementById('winnerPhoneNumber').textContent = `...${winnerPhone.slice(-4)}`;

      const contactArea = document.getElementById('winner-contact-area');
      const currentUserPhone = LocalState.getCurrentUserPhone();

      let contactButtonHtml = '';
      if (currentUserPhone === winnerPhone) {
          contactButtonHtml = `<button id="contactSellerButton" class="w-full btn btn-green">Neem contact op met Verkoper</button>`;
      } else if (currentUserPhone === auction.ownerPhone) {
          contactButtonHtml = `<button id="contactWinnerButton" class="w-full btn btn-green">Neem contact op met Winnaar</button>`;
      }
      contactArea.innerHTML = contactButtonHtml;

      if (currentUserPhone === winnerPhone) {
          document.getElementById('contactSellerButton').onclick = () => {
              const msg = `Hoi! Ik heb zojuist de veiling voor de ${auction.name} kaart gewonnen. Hoe regelen we de overdracht?`;
              window.open(`https://wa.me/${auction.ownerPhone}?text=${encodeURIComponent(msg)}`, '_blank');
          };
      } else if (currentUserPhone === auction.ownerPhone) {
          document.getElementById('contactWinnerButton').onclick = () => {
              const msg = `Gefeliciteerd met het winnen van de ${auction.name} kaart! Ik ben de verkoper, hoe regelen we de overdracht?`;
              window.open(`https://wa.me/${winnerPhone}?text=${encodeURIComponent(msg)}`, '_blank');
          };
      }

      showScreen('winner');
  }

  // --- Dashboard ---
  function showDashboard() {
      const currentUser = LocalState.getCurrentUserPhone();
      const myUploadsContainer = document.getElementById('dashboard-my-auctions');
      const participatedContainer = document.getElementById('dashboard-participated-auctions');

      myUploadsContainer.innerHTML = '';
      participatedContainer.innerHTML = '';

      const myUploads = state.allAuctions.filter(a => a.ownerPhone === currentUser);
      const participated = state.allAuctions.filter(a => a.participants.includes(currentUser));

      if (myUploads.length > 0) {
          myUploads.forEach(a => {
              const item = document.createElement('div');
              item.innerHTML = createDashboardItem(a, 'owner');
              myUploadsContainer.appendChild(item);
          });
      } else {
          myUploadsContainer.innerHTML = `<p class="text-white/70">Nog geen kaarten ge√ºpload.</p>`;
      }

      if (participated.length > 0) {
          participated.forEach(a => {
              const item = document.createElement('div');
              item.innerHTML = createDashboardItem(a, 'participant');
              participatedContainer.appendChild(item);
          });
      } else {
          participatedContainer.innerHTML = `<p class="text-white/70">Nog niet meegedaan aan veilingen.</p>`;
      }
  }

  function createDashboardItem(auction, role) {
    let statusText = `${auction.participants.length}/${auction.spots} spots`;
    let statusColor = 'text-yellow-300';
    if(auction.status === 'completed') {
        statusText = `Gewonnen door ...${auction.winner.slice(-4)}`;
        statusColor = 'text-green-400';
    } else if (auction.status === 'ready_to_spin') {
        statusText = 'Klaar om te draaien!';
        statusColor = 'text-orange-400';
    }

    let promoButtons = '';
    if (role === 'owner' && auction.status === 'active') {
        promoButtons = `
            <div class="flex gap-2 mt-2">
                <button class="btn btn-green btn-sm !py-1 !px-3 flex-1" data-action="share-whatsapp" data-id="${auction.id}">WhatsApp</button>
                <button class="btn btn-blue btn-sm !py-1 !px-3 flex-1" data-action="copy-link" data-id="${auction.id}">Kopieer</button>
            </div>
        `;
    }

    const clickableClass = role === 'participant' ? 'cursor-pointer hover:bg-white/20' : '';
    const dataAttribute = role === 'participant' ? `data-auction-id="${auction.id}"` : '';

    return `
      <div class="bg-white/10 p-2 rounded-lg ${clickableClass}" ${dataAttribute}>
          <div class="flex items-center">
              <img src="${auction.img}" alt="${auction.name}" class="w-10 h-14 object-cover rounded mr-3">
              <div class="text-white text-sm flex-grow">
                <p class="font-bold">${auction.name}</p>
                <p class="${statusColor} text-xs">${statusText}</p>
              </div>
          </div>
          ${promoButtons}
      </div>
    `;
  }

  // --- Promotion Helper Functions ---
  function getPromoLink(auctionId) {
      const cleanUrl = window.location.href.split('?')[0];
      return `${cleanUrl}?auctionId=${auctionId}`;
  }

  function shareOnWhatsApp(auctionId) {
      const auction = state.allAuctions.find(a => a.id === auctionId);
      if (!auction) return;
      const pricePerSpot = (auction.price / auction.spots).toFixed(2);
      const promoLink = getPromoLink(auctionId);
      const msg = `üî• Doe mee met de veiling voor een ${auction.name} voor maar ‚Ç¨${pricePerSpot}! Bekijk het hier: ${promoLink}`;
      window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
  }

  function copyPromoLink(auctionId, buttonElement) {
      const promoLink = getPromoLink(auctionId);
      navigator.clipboard.writeText(promoLink).then(() => {
          const originalText = buttonElement.textContent;
          buttonElement.textContent = 'Gekopieerd!';
          setTimeout(() => {
              buttonElement.textContent = originalText;
          }, 2000);
      });
  }

  // --- Initialization ---
  function initialize() {
      // Event listeners
      document.getElementById('authToggleButton').addEventListener('click', () => {
          state.isLogin = !state.isLogin;
          setupAuthScreen();
      });
      document.getElementById('authButton').addEventListener('click', () => handleAuth());
      document.getElementById('logoutButton').addEventListener('click', handleLogout);
      document.getElementById('logoutButtonDashboard').addEventListener('click', handleLogout);

      document.getElementById('goToDashboardButton').addEventListener('click', () => showScreen('dashboard'));
      document.getElementById('backToCardsButton').addEventListener('click', () => showScreen('cards'));
      document.getElementById('uploadFileTriggerButton').addEventListener('click', () => document.getElementById('uploadFileInput').click());
      document.getElementById('uploadFileInput').addEventListener('change', handleFileUpload);
      document.getElementById('saveUploadButton').addEventListener('click', (e) => saveUploadedCard(e.currentTarget));
      document.getElementById('dashboardBackButton').addEventListener('click', () => showScreen('cards'));
      document.getElementById('promotionDoneButton').addEventListener('click', () => showScreen('cards'));
      document.getElementById('backToAuctionsButton').addEventListener('click', () => showScreen('cards'));
      document.getElementById('winnerDoneButton').addEventListener('click', () => showScreen('cards'));
      document.getElementById('buySpotButton').addEventListener('click', handleBuySpot);
      document.getElementById('checkout-pay-button').addEventListener('click', (e) => processPayment(e.currentTarget));
      document.getElementById('checkout-cancel-button').addEventListener('click', () => showScreen('auctionJoin', state.currentAuctionId));
      imageModalClose.addEventListener('click', hideImageModal);
      imageModal.addEventListener('click', (e) => {
        if (e.target === imageModal) {
            hideImageModal();
        }
      });
      document.getElementById('shareWhatsappAuctionJoin').addEventListener('click', () => {
        if(state.currentAuctionId) {
          shareOnWhatsApp(state.currentAuctionId);
        }
      });

      document.getElementById('active-auctions-list').addEventListener('click', (e) => {
          const auctionElement = e.target.closest('[data-auction-id]');
          if (!auctionElement) return;

          const { auctionId, isFull } = auctionElement.dataset;

          if (isFull === 'true') {
              showWheelScreen(auctionId);
          } else {
              showScreen('loader');
              setTimeout(() => {
                  showScreen('auctionJoin', auctionId);
              }, 500);
          }
      });

      document.getElementById('dashboard-my-auctions').addEventListener('click', (e) => {
          const button = e.target.closest('button');
          if (!button) return;

          const { action, id } = button.dataset;
          if (action === 'share-whatsapp') {
              shareOnWhatsApp(id);
          } else if (action === 'copy-link') {
              copyPromoLink(id, button);
          }
      });

      document.getElementById('dashboard-participated-auctions').addEventListener('click', (e) => {
          const auctionElement = e.target.closest('[data-auction-id]');
          if (!auctionElement) return;

          const auctionId = auctionElement.dataset.auctionId;
          showScreen('loader');
          setTimeout(() => {
              showScreen('auctionJoin', auctionId);
          }, 500);
      });

      // Legal Modals Listeners
      const openTerms = () => termsModal.classList.remove('hidden');
      const closeTerms = () => termsModal.classList.add('hidden');
      const openPrivacy = () => privacyModal.classList.remove('hidden');
      const closePrivacy = () => privacyModal.classList.add('hidden');

      document.getElementById('show-terms-link').addEventListener('click', openTerms);
      document.getElementById('footer-terms-link').addEventListener('click', openTerms);
      document.getElementById('close-terms-modal').addEventListener('click', closeTerms);

      document.getElementById('show-privacy-link').addEventListener('click', openPrivacy);
      document.getElementById('footer-privacy-link').addEventListener('click', openPrivacy);
      document.getElementById('close-privacy-modal').addEventListener('click', closePrivacy);

      // Checkbox logic
      document.getElementById('legal-agree-checkbox').addEventListener('change', (e) => {
          document.getElementById('authButton').disabled = !e.target.checked;
      });
      document.getElementById('withdrawal-agree-checkbox').addEventListener('change', (e) => {
          document.getElementById('checkout-pay-button').disabled = !e.target.checked;
      });

      // Listen for real-time updates from Firestore
      const q = collection(db, "auctions");
      onSnapshot(q, (querySnapshot) => {
          const auctions = [];
          querySnapshot.forEach((doc) => {
              auctions.push(doc.data());
          });
          state.allAuctions = auctions.sort((a,b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));

          const currentVisibleScreen = document.querySelector('.app-container > div:not(.hidden)');
          if (currentVisibleScreen) {
              const currentScreenId = currentVisibleScreen.id.replace('-screen', '');
              if (currentScreenId === 'cards' || currentScreenId === 'loader') {
                renderActiveAuctions();
              }
              if (currentScreenId === 'auctionJoin' && state.currentAuctionId) {
                const currentAuctionData = state.allAuctions.find(a => a.id === state.currentAuctionId);
                if (currentAuctionData) {
                  updateAuctionJoinUI(currentAuctionData);
                }
              }
          }
      }, (error) => {
        console.error("Firestore snapshot error:", error);
        showToast("Kon veilingen niet laden. Controleer de Firebase regels.", "error");
      });


      // Initial state
      setTimeout(() => {
          const urlParams = new URLSearchParams(window.location.search);
          const paymentSuccess = urlParams.get('payment_success');
          const paymentCancelled = urlParams.get('payment_cancelled');
          const auctionId = urlParams.get('auctionId');

          if (paymentSuccess && auctionId) {
              history.replaceState(null, '', window.location.pathname);
              if (LocalState.getCurrentUserPhone()) {
                  handleSuccessfulPayment(auctionId);
              } else {
                  LocalState.setPendingAuctionId(auctionId);
                  document.getElementById('auth-context-message').textContent = "Betaling geslaagd! Login om je aankoop te bevestigen.";
                  showScreen('auth');
              }
              return;
          }

          if (paymentCancelled) {
              showToast("Betaling geannuleerd.", "error");
              history.replaceState(null, '', window.location.pathname);
          }

          if (auctionId) {
              LocalState.setPendingAuctionId(auctionId);
          }

          if (LocalState.getCurrentUserPhone()) {
              loginSuccess(LocalState.getCurrentUserPhone());
          } else {
              if (auctionId) {
                  const msg = `Je bent uitgenodigd voor een veiling. Login om mee te doen.`;
                  document.getElementById('auth-context-message').textContent = msg;
                  showScreen('auth');
              } else {
                  showScreen('cards');
              }
          }
          updateHeaderButtons();
      }, 500);
  }

  initialize();
</script>

</body>
</html>

